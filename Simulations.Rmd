---
title: "Simulations"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(MASS)
```

# Read and filter the data
```{r}
data <- read_csv("Data/game.csv")
data <- data %>% filter(data$season == 20132014, data$home_team_id %in% c(seq(1,30), 52), data$away_team_id %in% c(seq(1,30), 52), data$type == 'R')
data$home_team_id[data$home_team_id == 52] <- 11
data$away_team_id[data$away_team_id == 52] <- 11
```

# The Model
```{r}
# There are three key parameters: the probability that the worst team in the league beats the best team in a random game (given by 'p'), the standard deviation in game-to-game performance levels for each team (given by 'tao'), and the standard deviation in the team talent levels (given by 'sigma'). We as the researchers choose a value for p or the ratio of tao and sigma.
p = 0.25
tao = 4.28
sigma = 1

# Draw a "team quality" value for all teams.
teamQuality <- rnorm(30, 0, sigma)

# Calculate tie threshhold.
alpha <- qnorm(0.612, 0, sqrt(2 * (tao^2 + sigma^2)))


```

# Simulating a season
```{r}
simulateSeason <- function() {
  # Create overall games matrix with format:
  # GAME | TEAM 1 | TEAM 2 | GAMMA 1 | GAMMA 2 | GAMMA 1 - GAMMA 2 | OUTCOME 1 | OUTCOME 2
  # Where 'outcome' is the number of points awarded to their respective teams
  games <- list(seq(1, dim(data[1])[1]), rep(0, dim(data[1])[1]), rep(0, dim(data[1])[1]), rep(0, dim(data[1])[1]), rep(0, dim(data[1])[1]), rep(0, dim(data[1])[1]), rep(0, dim(data[1])[1]), rep(0, dim(data[1])[1]))
  
  # Go through the games
  for (game in 1:length(games[[1]])) {
    
    # Get the teams for each game and put them in the games matrix
    homeTeam <- getHomeTeam(game)
    awayTeam <- getAwayTeam(game)
    
    games[[2]][game] <- homeTeam
    games[[3]][game] <- awayTeam
      
    # Extract game performance values -- insert into games matrix
    homePerformance <- rnorm(n = 1, teamQuality[homeTeam], tao)
    awayPerformance <- rnorm(n = 1, teamQuality[awayTeam], tao)
    
    games[[4]][game] <- homePerformance
    games[[5]][game] <- awayPerformance
    
    # Check if there is a tie -- store difference for later
    games[[6]][game] <- homePerformance - awayPerformance
  }
  a <- mean(games[[6]])
  b <- max(games[[6]])
  
  # Go through and calculate outcomes
  for (game in 1:length(games[[1]])) {
    # If there is a tie award 2 points to the 'winner'
    if (abs(games[[6]][game]) >= alpha) {
      if (games[[6]][game] >= 0) {
        games[[7]][game] <- 2
      }
      else {
        games[[8]][game] <- 2
      }
    }
    # Else rescale performances and simulate a winner, giving two points to the winner and one to the loser
    else {
      zeta <- (games[[6]][game] - a) / b
      if (rbernoulli(1, p = zeta)) {
        games[[7]][game] <- 2
        games[[8]][game] <- 1
      }
      else {
        games[[7]][game] <- 1
        games[[8]][game] <- 2
      }
    }
  }
  return(games)
}
```

# Helper functions
```{r}
getHomeTeam <- function(index) {
  return (data$home_team_id[index])
}

getAwayTeam <- function(index) {
  return (data$away_team_id[index])
}

overtime <- function() {
  
}
```











